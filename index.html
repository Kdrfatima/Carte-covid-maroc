<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carte Interactive du Maroc - Toutes les R√©gions</title>
  <script src="https://unpkg.com/d3@7.8.5/dist/d3.min.js"></script>
  <script src="https://unpkg.com/topojson@3.0.2/dist/topojson.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, rgb(73, 198, 255) 0%, #92fdc8 100%);
      min-height: 100vh;
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .header p {
      font-size: 1.2em;
      opacity: 0.9;
    }

    .content {
      display: flex;
      gap: 30px;
      width: 100%;
      flex-wrap: wrap;
      justify-content: center;
    }

    .map-container,
    .chart-container {
      background: rgb(233, 225, 225);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .map-container {
      flex: 1;
      min-width: 500px;
    }

    .chart-container {
      flex: 1;
      min-width: 400px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .region {
      fill: #b7ced3;
      stroke: rgb(255, 255, 255);
      stroke-width: 1.5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .region:hover {
      fill: #2196F3;
      stroke-width: 2.5px;
    }

    .selected {
      fill: #FF9800;
      stroke-width: 3px;
      stroke: #333;
      filter: drop-shadow(0 0 8px rgba(255, 152, 0, 0.6));
    }

    .region-with-data {
      fill: #4CAF50;
    }

    .region-without-data {
      fill: #9E9E9E;
    }

    .doughnut-chart {
      margin: 20px 0;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 20px;
      transition: all 0.3s ease;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 8px;
      border: 2px solid white;
    }

    .legend-text {
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }

    #tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.95);
      color: white;
      padding: 15px;
      border-radius: 10px;
      pointer-events: none;
      font-size: 14px;
      display: none;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      z-index: 1000;
    }

    .chart-title {
      font-size: 1.5em;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
      text-align: center;
    }

    .no-data {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 40px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 2px dashed #ddd;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
      width: 100%;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-value {
      font-size: 1.8em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9em;
      opacity: 0.9;
    }

    .region-info {
      margin-top: 15px;
      padding: 15px;
      background: #e3f2fd;
      border-radius: 8px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üåç Carte Interactive du Maroc</h1>
      <p>Toutes les r√©gions marocaines - Cliquez pour voir les donn√©es</p>
    </div>

    <div class="content">
      <div class="map-container">
        <h2 style="text-align: center; color: #333; margin-bottom: 20px;">Carte des 12 R√©gions du Maroc</h2>
        <svg id="map" width="500" height="500"></svg>
        <div class="region-info">
          <p><strong>üü¢ R√©gions avec donn√©es</strong> | <strong>‚ö™ R√©gions sans donn√©es</strong></p>
          <p>Cliquez sur n'importe quelle r√©gion pour voir les d√©tails</p>
        </div>
      </div>

      <div class="chart-container">
        <h2 style="text-align: center; color: #333; margin-bottom: 20px;">Visualisation des Donn√©es</h2>
        <div id="doughnut-container">
          <div class="no-data">
            <h3>üéØ S√©lectionnez une r√©gion</h3>
            <p>Cliquez sur une r√©gion de la carte pour afficher ses donn√©es</p>
            <p><strong>12 r√©gions disponibles</strong></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="tooltip"></div>

  <script>
    // Configuration
    const width = 500;
    const height = 500;
    const doughnutWidth = 350;
    const doughnutHeight = 350;

    // S√©lections D3
    const svg = d3.select("#map")
      .attr("width", width)
      .attr("height", height);

    const doughnutContainer = d3.select("#doughnut-container");
    const tooltip = d3.select("#tooltip");

    // √âchelle de couleur pour la carte
    const regionColorScale = d3.scaleSequential(d3.interpolateBlues);

    // Fonction de normalisation am√©lior√©e
    function normalize(str) {
      return (str || '')
        .toString()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/[^a-z0-9]/g, '')
        .replace(/\s+/g, '');
    }

    // Chargement de toutes les donn√©es
    Promise.all([
      d3.json("https://cdn.jsdelivr.net/npm/morocco-map/data/regions.json"),
      d3.json("./covid_regions_maroc.json"),
      d3.json("./regions_data.json"),
      d3.json("./region_mapping.json")
    ]).then(([mapData, covidData, regionsData, regionMapping]) => {
      const regions = topojson.feature(mapData, mapData.objects.regions);
      const projection = d3.geoMercator().fitSize([width, height], regions);
      const pathGenerator = d3.geoPath().projection(projection);

      // Index des donn√©es COVID
      const covidByNormalizedName = {};
      covidData.forEach(r => {
        if (r.region) {
          covidByNormalizedName[normalize(r.region)] = r;
        }
        if (r.Code) {
          covidByNormalizedName[r.Code] = r;
        }
      });

      // Construire un mapping pour regionsData (le fichier est un tableau)
      const regionsDataMap = {};
      if (Array.isArray(regionsData)) {
        regionsData.forEach(r => {
          if (!r) return;
          if (r.Code) regionsDataMap[r.Code] = r;
          if (r.id) regionsDataMap[r.id] = r;
          if (r.region) regionsDataMap[r.region] = r;
          regionsDataMap[normalize(r.region)] = r;
        });
      } else if (typeof regionsData === 'object') {
        Object.assign(regionsDataMap, regionsData);
      }

      const maxCases = d3.max(covidData, d => d.Confirmed) || 1;
      regionColorScale.domain([0, maxCases]);

      // Fonction am√©lior√©e pour trouver les donn√©es d'une r√©gion
      function findRegionData(feature) {
        const props = feature.properties || {};

        // Essayer par code direct
        const code = props.code || props.id || props.ISO3166_2;
        if (code && regionsDataMap[code]) {
          return { code, data: regionsDataMap[code] };
        }

        // Essayer par nom avec mapping
        const name = props['name:en'] || props.name || props.nom || props.NAME_1 || props.NAME || '';
        const normalizedName = normalize(name);

        // Chercher dans le mapping
        for (const [regionName, regionCode] of Object.entries(regionMapping)) {
          if (normalize(regionName) === normalizedName) {
              if (regionsDataMap[regionCode]) {
                return { code: regionCode, data: regionsDataMap[regionCode] };
              }
          }
        }

        // Correspondance partielle
        for (const [regionKey, regionData] of Object.entries(regionsDataMap)) {
          if (!regionData || !regionData.region) continue;
          const regionNormalized = normalize(regionData.region);
          if (regionNormalized.includes(normalizedName) || normalizedName.includes(regionNormalized)) {
            console.log(`Correspondance partielle: ${name} -> ${regionData.region}`);
            return { code: regionKey, data: regionData };
          }
        }

        return null;
      }

      // Dessin de la carte
      svg.selectAll("path")
        .data(regions.features)
        .enter()
        .append("path")
        .attr("class", "region")
        .attr("d", pathGenerator)
        .attr("fill", d => {
          const regionInfo = findRegionData(d);
          return regionInfo ? "#4CAF50" : "#9E9E9E";
        })
        .on("mouseover", function (event, d) {
          const props = d.properties || {};
          const name = props['name:en'] || props.name || "R√©gion inconnue";
          const normalizedName = normalize(name);
          const covidInfo = covidByNormalizedName[normalizedName];
          const regionInfo = findRegionData(d);

          let tooltipContent = `<strong>${name}</strong>`;

          // Preferer les donn√©es compl√®tes de regionsData (regionsDataMap) si disponibles
          if (regionInfo && regionInfo.data) {
            const rd = regionInfo.data;
            if (rd.Confirmed != null) tooltipContent += `<br/>ü¶† Cas confirm√©s: ${rd.Confirmed}`;
            if (rd.Deaths != null) tooltipContent += `<br/>üíÄ D√©c√®s: ${rd.Deaths}`;
            if (rd.Recovered != null) tooltipContent += `<br/>üíö Gu√©risons: ${rd.Recovered}`;
            if (rd.population != null) tooltipContent += `<br/>üë• Population: ${Number(rd.population).toLocaleString()}`;
            if (rd.contribution_gdp != null) tooltipContent += `<br/>üè¶ PIB: ${rd.contribution_gdp}`;
            tooltipContent += `<br/><em>‚úÖ Donn√©es disponibles ‚Äî cliquez pour d√©tail</em>`;
          } else if (covidInfo) {
            // Fallback to covidData when regionsData not available
            tooltipContent += `<br/>ü¶† Cas confirm√©s: ${covidInfo.Confirmed}`;
            tooltipContent += `<br/>üíÄ D√©c√®s: ${covidInfo.Deaths}`;
            if (covidInfo.population) {
              tooltipContent += `<br/>üë• Population: ${covidInfo.population.toLocaleString()}`;
            }
            tooltipContent += `<br/><em>‚úÖ Donn√©es disponibles ‚Äî cliquez pour d√©tail</em>`;
          } else {
            tooltipContent += `<br/>‚ùå Donn√©es non disponibles`;
          }

          tooltip.style("display", "block")
            .html(tooltipContent)
            .style("left", (event.pageX + 15) + "px")
            .style("top", (event.pageY - 15) + "px");
        })
        .on("mousemove", function (event) {
          tooltip.style("left", (event.pageX + 15) + "px")
            .style("top", (event.pageY - 15) + "px");
        })
        .on("mouseout", function () {
          tooltip.style("display", "none");
        })
        .on("click", function (event, d) {
          // Retirer la s√©lection pr√©c√©dente
          svg.selectAll(".region").classed("selected", false);

          // S√©lectionner la r√©gion cliqu√©e
          d3.select(this).classed("selected", true);

          const regionInfo = findRegionData(d);
          const props = d.properties || {};
          const name = props['name:en'] || props.name || "R√©gion inconnue";

          if (regionInfo) {
            showDoughnutChart(regionInfo.code, regionInfo.data);
          } else {
            showNoDataMessage(name);
          }
        });

      // Ajouter les labels des r√©gions
      svg.selectAll("text")
        .data(regions.features)
        .enter()
        .append("text")
        .attr("transform", d => {
          const centroid = pathGenerator.centroid(d);
          return `translate(${centroid[0]}, ${centroid[1]})`;
        })
        .attr("text-anchor", "middle")
        .attr("dy", "0.35em")
        .style("font-size", "8px")
        .style("font-weight", "bold")
        .style("fill", "white")
        .style("text-shadow", "1px 1px 2px black")
        .style("pointer-events", "none")
        .text(d => {
          const props = d.properties || {};
          const name = props['name:en'] || props.name || "";
          // Raccourcir les noms longs
          if (name.length > 15) {
            return name.split(' ')[0];
          }
          return name;
        });

      console.log("Carte charg√©e avec succ√®s - 12 r√©gions disponibles");

    }).catch(err => {
      console.error("Erreur de chargement:", err);
      alert("Erreur de chargement des donn√©es. V√©rifiez les fichiers regions_data.json et region_mapping.json");
    });

    // Fonction pour afficher le doughnut chart
    function showDoughnutChart(regionCode, regionDataRaw) {
      // regionDataRaw: objet brut contenant les champs (Confirmed, Deaths, Recovered, population, contribution_gdp, ...)
      console.log("Affichage des donn√©es pour:", regionCode, regionDataRaw);

      // Nettoyer le conteneur pr√©c√©dent
      doughnutContainer.selectAll("*").remove();

      // Construire les cat√©gories √† afficher √† partir de l'objet brut
      const keysToShow = [
        { key: 'Confirmed', label: 'Cas confirm√©s', color: '#ff6b6b' },
        { key: 'Deaths', label: 'D√©c√®s', color: '#6b6bff' },
        { key: 'Recovered', label: 'Gu√©risons', color: '#6bff95' },
        { key: 'population', label: 'Population', color: '#ffa94d' },
        { key: 'contribution_gdp', label: 'PIB (%)', color: '#8d6bff' }
      ];

      const data = [];
      keysToShow.forEach(k => {
        if (regionDataRaw[k.key] != null) {
          let value = regionDataRaw[k.key];
          // Convertir pourcentage string en nombre
          if (typeof value === 'string' && value.trim().endsWith('%')) {
            value = parseFloat(value.replace('%', '').replace(',', '.'));
          }
          // population might be null
          if (typeof value === 'number' && !isNaN(value) && value > 0) {
            data.push({ category: k.label, value: value, color: k.color });
          }
        }
      });

      // Si aucun champ num√©rique trouv√©, afficher message
      if (!data.length) {
        showNoDataMessage(regionDataRaw.region || regionCode);
        return;
      }

      // Cr√©er le conteneur principal
      const chartDiv = doughnutContainer.append("div")
        .attr("class", "doughnut-chart-container");

      // Ajouter le titre
      chartDiv.append("h3")
        .attr("class", "chart-title")
        .text(`üìä ${regionDataRaw.region || regionCode}`);

      // Cr√©er le SVG pour le doughnut
      const svg = chartDiv.append("svg")
        .attr("width", doughnutWidth)
        .attr("height", doughnutHeight)
        .attr("class", "doughnut-chart")
        .append("g")
        .attr("transform", `translate(${doughnutWidth / 2}, ${doughnutHeight / 2})`);

      const radius = Math.min(doughnutWidth, doughnutHeight) / 2;

      // Cr√©er l'arc pour le doughnut
      const arc = d3.arc()
        .innerRadius(radius * 0.6)
        .outerRadius(radius);

      // Cr√©er le pie generator
      const pie = d3.pie()
        .value(d => d.value)
        .sort(null);

      // Cr√©er les arcs
      const arcs = svg.selectAll("arc")
        .data(pie(data))
        .enter()
        .append("g")
        .attr("class", "arc");

      // Dessiner les arcs
      arcs.append("path")
        .attr("d", arc)
        .attr("fill", d => d.data.color)
        .attr("stroke", "white")
        .attr("stroke-width", 2)
        .on("mouseover", function (event, d) {
          const total = d3.sum(data, x => x.value);
          const percentage = ((d.data.value / total) * 100).toFixed(1);
          tooltip.style("display", "block")
            .html(`
                            <strong>${d.data.category}</strong><br/>
                            üî¢ Valeur: ${d.data.value}<br/>
                            üìä Pourcentage: ${percentage}%
                        `)
            .style("left", (event.pageX + 15) + "px")
            .style("top", (event.pageY - 15) + "px");

          d3.select(this)
            .transition()
            .duration(200)
            .attr("transform", "scale(1.05)");
        })
        .on("mousemove", function (event) {
          tooltip.style("left", (event.pageX + 15) + "px")
            .style("top", (event.pageY - 15) + "px");
        })
        .on("mouseout", function () {
          tooltip.style("display", "none");
          d3.select(this)
            .transition()
            .duration(200)
            .attr("transform", "scale(1)");
        });

      // Ajouter la l√©gende
      const legend = chartDiv.append("div")
        .attr("class", "legend");

      const legendItems = legend.selectAll(".legend-item")
        .data(data)
        .enter()
        .append("div")
        .attr("class", "legend-item");

      legendItems.append("div")
        .attr("class", "legend-color")
        .style("background-color", d => d.color);

      legendItems.append("span")
        .attr("class", "legend-text")
        .text(d => `${d.category}: ${d.value}`);

      // Ajouter les statistiques
      const total = d3.sum(data, d => d.value);
      const statsGrid = chartDiv.append("div")
        .attr("class", "stats-grid");

      statsGrid.append("div")
        .attr("class", "stat-card")
        .html(`
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">Total</div>
                `);

      statsGrid.append("div")
        .attr("class", "stat-card")
        .html(`
                    <div class="stat-value">${data.length}</div>
                    <div class="stat-label">Cat√©gories</div>
                `);

      const maxCategory = d3.max(data, d => d.value);
      statsGrid.append("div")
        .attr("class", "stat-card")
        .html(`
                    <div class="stat-value">${maxCategory}</div>
                    <div class="stat-label">Maximum</div>
                `);

      const avg = Math.round(total / data.length);
      statsGrid.append("div")
        .attr("class", "stat-card")
        .html(`
                    <div class="stat-value">${avg}</div>
                    <div class="stat-label">Moyenne</div>
                `);
    }

    // Fonction pour afficher le message "pas de donn√©es"
    function showNoDataMessage(regionName) {
      doughnutContainer.selectAll("*").remove();

      doughnutContainer.append("div")
        .attr("class", "no-data")
        .html(`
                    <h3>‚ùå Donn√©es non disponibles</h3>
                    <p>La r√©gion "${regionName}" ne dispose pas de donn√©es pour le moment.</p>
                    <p>Veuillez s√©lectionner une autre r√©gion.</p>
                `);
    }
  </script>
</body>

</html>