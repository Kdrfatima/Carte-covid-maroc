<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carte Interactive du Maroc - Donut Chart</title>
  <script src="https://unpkg.com/d3@7.8.5/dist/d3.min.js"></script>
  <script src="https://unpkg.com/topojson@3.0.2/dist/topojson.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .header p {
      font-size: 1.2em;
      opacity: 0.9;
    }

    .content {
      display: flex;
      gap: 30px;
      width: 100%;
      flex-wrap: wrap;
      justify-content: center;
    }

    .map-container,
    .chart-container {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    .map-container {
      flex: 1;
      min-width: 500px;
    }

    .chart-container {
      flex: 1;
      min-width: 400px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .region {
      fill: #4CAF50;
      stroke: white;
      stroke-width: 1.5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .region:hover {
      fill: #2196F3;
      stroke-width: 2.5px;
      transform: scale(1.02);
    }

    .selected {
      fill: #FF9800;
      stroke-width: 3px;
      stroke: #333;
      filter: drop-shadow(0 0 8px rgba(255, 152, 0, 0.6));
    }

    .doughnut-chart {
      margin: 20px 0;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 20px;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .legend-item:hover {
      background: #e9ecef;
      border-color: #007bff;
      transform: translateY(-2px);
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 8px;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .legend-text {
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }

    #tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.95);
      color: white;
      padding: 15px;
      border-radius: 10px;
      pointer-events: none;
      font-size: 14px;
      display: none;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1000;
      max-width: 300px;
    }

    .chart-title {
      font-size: 1.5em;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
      text-align: center;
    }

    .no-data {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 40px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 2px dashed #ddd;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
      width: 100%;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-value {
      font-size: 1.8em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9em;
      opacity: 0.9;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üåç Carte Interactive du Maroc</h1>
      <p>Cliquez sur une r√©gion pour voir la r√©partition des donn√©es</p>
    </div>

    <div class="content">
      <div class="map-container">
        <h2 style="text-align: center; color: #333; margin-bottom: 20px;">Carte des R√©gions</h2>
        <svg id="map" width="500" height="500"></svg>
      </div>

      <div class="chart-container">
        <h2 style="text-align: center; color: #333; margin-bottom: 20px;">Visualisation des Donn√©es</h2>
        <div id="doughnut-container">
          <div class="no-data">
            <h3>üéØ S√©lectionnez une r√©gion</h3>
            <p>Cliquez sur une r√©gion de la carte pour afficher ses donn√©es</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="tooltip"></div>

  <script>
    // Donn√©es simplifi√©es pour le doughnut chart
    const regionData = {
      "TTH": {
        region: "Tanger-T√©touan-Al Hoceima",
        data: [
          { category: "Sant√©", value: 45, color: "#FF6B6B" },
          { category: "√âducation", value: 35, color: "#4ECDC4" },
          { category: "Infrastructure", value: 60, color: "#45B7D1" },
          { category: "Tourisme", value: 80, color: "#FFA07A" },
          { category: "Agriculture", value: 40, color: "#98D8C8" }
        ]
      },
      "CS": {
        region: "Casablanca-Settat",
        data: [
          { category: "Sant√©", value: 85, color: "#FF6B6B" },
          { category: "√âducation", value: 65, color: "#4ECDC4" },
          { category: "Infrastructure", value: 90, color: "#45B7D1" },
          { category: "Tourisme", value: 120, color: "#FFA07A" },
          { category: "Industrie", value: 150, color: "#F7DC6F" }
        ]
      },
      "FM": {
        region: "F√®s-Mekn√®s",
        data: [
          { category: "Sant√©", value: 35, color: "#FF6B6B" },
          { category: "√âducation", value: 45, color: "#4ECDC4" },
          { category: "Infrastructure", value: 40, color: "#45B7D1" },
          { category: "Artisanat", value: 70, color: "#BB8FCE" },
          { category: "Agriculture", value: 55, color: "#98D8C8" }
        ]
      },
      "RSK": {
        region: "Rabat-Sal√©-K√©nitra",
        data: [
          { category: "Sant√©", value: 55, color: "#FF6B6B" },
          { category: "√âducation", value: 75, color: "#4ECDC4" },
          { category: "Infrastructure", value: 65, color: "#45B7D1" },
          { category: "Administration", value: 95, color: "#85C1E9" },
          { category: "Services", value: 85, color: "#F8C471" }
        ]
      },
      "MS": {
        region: "Marrakesh-Safi",
        data: [
          { category: "Sant√©", value: 40, color: "#FF6B6B" },
          { category: "√âducation", value: 30, color: "#4ECDC4" },
          { category: "Tourisme", value: 110, color: "#FFA07A" },
          { category: "Artisanat", value: 65, color: "#BB8FCE" },
          { category: "Agriculture", value: 50, color: "#98D8C8" }
        ]
      },
      "SM": {
        region: "Souss-Massa",
        data: [
          { category: "Sant√©", value: 30, color: "#FF6B6B" },
          { category: "√âducation", value: 25, color: "#4ECDC4" },
          { category: "Agriculture", value: 85, color: "#98D8C8" },
          { category: "P√™che", value: 45, color: "#5499C7" },
          { category: "Tourisme", value: 60, color: "#FFA07A" }
        ]
      }
    };

    // Configuration
    const width = 500;
    const height = 500;
    const doughnutWidth = 350;
    const doughnutHeight = 350;
    const doughnutRadius = Math.min(doughnutWidth, doughnutHeight) / 2;

    // S√©lections D3
    const svg = d3.select("#map")
      .attr("width", width)
      .attr("height", height);

    const doughnutContainer = d3.select("#doughnut-container");
    const tooltip = d3.select("#tooltip");

    // √âchelle de couleur pour la carte
    const regionColorScale = d3.scaleSequential(d3.interpolateBlues);

    // Fonction de normalisation
    function normalize(str) {
      return (str || '')
        .toString()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/[^a-z0-9]/g, '');
    }

    // Chargement des donn√©es
    Promise.all([
      d3.json("https://cdn.jsdelivr.net/npm/morocco-map/data/regions.json"),
      d3.json("./covid_regions_maroc.json")
    ]).then(([mapData, covidData]) => {
      const regions = topojson.feature(mapData, mapData.objects.regions);
      const projection = d3.geoMercator().fitSize([width, height], regions);
      const pathGenerator = d3.geoPath().projection(projection);

      // Index des donn√©es COVID
      const covidByNormalizedName = {};
      covidData.forEach(r => {
        if (r.region) {
          covidByNormalizedName[normalize(r.region)] = r;
        }
        if (r.Code) {
          covidByNormalizedName[r.Code] = r;
        }
      });

      const maxCases = d3.max(covidData, d => d.Confirmed) || 1;
      regionColorScale.domain([0, maxCases]);

      // Fonction pour trouver les donn√©es d'une r√©gion
      function findRegionData(feature) {
        const props = feature.properties || {};

        // Essayer par code
        const code = props.code || props.id || props.ISO3166_2;
        if (code && regionData[code]) {
          return { code, data: regionData[code] };
        }

        // Essayer par nom normalis√©
        const name = props['name:en'] || props.name || props.nom || props.NAME_1 || props.NAME || '';
        const normalizedName = normalize(name);

        // Correspondance par nom de r√©gion
        for (const [regionCode, regionDataItem] of Object.entries(regionData)) {
          if (normalize(regionDataItem.region) === normalizedName) {
            return { code: regionCode, data: regionDataItem };
          }
        }

        return null;
      }

      // Dessin de la carte
      svg.selectAll("path")
        .data(regions.features)
        .enter()
        .append("path")
        .attr("class", "region")
        .attr("d", pathGenerator)
        .attr("fill", d => {
          const props = d.properties || {};
          const name = props['name:en'] || props.name || "Inconnu";
          const normalizedName = normalize(name);
          const covidInfo = covidByNormalizedName[normalizedName];
          return covidInfo ? regionColorScale(covidInfo.Confirmed) : "#e0e0e0";
        })
        .on("mouseover", function (event, d) {
          const props = d.properties || {};
          const name = props['name:en'] || props.name || "R√©gion inconnue";
          const normalizedName = normalize(name);
          const covidInfo = covidByNormalizedName[normalizedName];
          const regionInfo = findRegionData(d);

          let tooltipContent = `<strong>${name}</strong>`;

          if (covidInfo) {
            tooltipContent += `<br/>ü¶† Cas confirm√©s: ${covidInfo.Confirmed}`;
            tooltipContent += `<br/>üíÄ D√©c√®s: ${covidInfo.Deaths}`;
          }

          if (regionInfo) {
            tooltipContent += `<br/>‚úÖ Donn√©es disponibles - Cliquez !`;
          } else {
            tooltipContent += `<br/>‚ùå Donn√©es non disponibles`;
          }

          tooltip.style("display", "block")
            .html(tooltipContent)
            .style("left", (event.pageX + 15) + "px")
            .style("top", (event.pageY - 15) + "px");
        })
        .on("mousemove", function (event) {
          tooltip.style("left", (event.pageX + 15) + "px")
            .style("top", (event.pageY - 15) + "px");
        })
        .on("mouseout", function () {
          tooltip.style("display", "none");
        })
        .on("click", function (event, d) {
          // Retirer la s√©lection pr√©c√©dente
          svg.selectAll(".region").classed("selected", false);

          // S√©lectionner la r√©gion cliqu√©e
          d3.select(this).classed("selected", true);

          const regionInfo = findRegionData(d);
          const props = d.properties || {};
          const name = props['name:en'] || props.name || "R√©gion inconnue";

          if (regionInfo) {
            showDoughnutChart(regionInfo.code, regionInfo.data);
          } else {
            showNoDataMessage(name);
          }
        });

      // Ajouter les labels des r√©gions
      svg.selectAll("text")
        .data(regions.features)
        .enter()
        .append("text")
        .attr("transform", d => {
          const centroid = pathGenerator.centroid(d);
          return `translate(${centroid[0]}, ${centroid[1]})`;
        })
        .attr("text-anchor", "middle")
        .attr("dy", "0.35em")
        .style("font-size", "9px")
        .style("font-weight", "bold")
        .style("fill", "white")
        .style("text-shadow", "1px 1px 2px black")
        .style("pointer-events", "none")
        .text(d => {
          const props = d.properties || {};
          const name = props['name:en'] || props.name || "";
          return name.length > 12 ? name.substring(0, 10) + '...' : name;
        });

    }).catch(err => {
      console.error("Erreur de chargement:", err);
      alert("Erreur de chargement des donn√©es de la carte");
    });

    // Fonction pour afficher le doughnut chart
    function showDoughnutChart(regionCode, regionData) {
      console.log("Affichage du doughnut chart pour:", regionCode, regionData);

      // Nettoyer le conteneur pr√©c√©dent
      doughnutContainer.selectAll("*").remove();

      // Cr√©er le conteneur principal
      const chartDiv = doughnutContainer.append("div")
        .attr("class", "doughnut-chart-container");

      // Ajouter le titre
      chartDiv.append("h3")
        .attr("class", "chart-title")
        .text(`üìä ${regionData.region}`);

      // Cr√©er le SVG pour le doughnut
      const svg = chartDiv.append("svg")
        .attr("width", doughnutWidth)
        .attr("height", doughnutHeight)
        .attr("class", "doughnut-chart")
        .append("g")
        .attr("transform", `translate(${doughnutWidth / 2}, ${doughnutHeight / 2})`);

      // Cr√©er l'arc pour le doughnut
      const arc = d3.arc()
        .innerRadius(doughnutRadius * 0.6)
        .outerRadius(doughnutRadius);

      // Cr√©er le pie generator
      const pie = d3.pie()
        .value(d => d.value)
        .sort(null);

      // Cr√©er les arcs
      const arcs = svg.selectAll("arc")
        .data(pie(regionData.data))
        .enter()
        .append("g")
        .attr("class", "arc");

      // Dessiner les arcs
      arcs.append("path")
        .attr("d", arc)
        .attr("fill", d => d.data.color)
        .attr("stroke", "white")
        .attr("stroke-width", 2)
        .on("mouseover", function (event, d) {
          const percentage = ((d.data.value / d3.sum(regionData.data, x => x.value)) * 100).toFixed(1);
          tooltip.style("display", "block")
            .html(`
                            <strong>${d.data.category}</strong><br/>
                            üî¢ Valeur: ${d.data.value}<br/>
                            üìä Pourcentage: ${percentage}%
                        `)
            .style("left", (event.pageX + 15) + "px")
            .style("top", (event.pageY - 15) + "px");

          d3.select(this)
            .transition()
            .duration(200)
            .attr("transform", "scale(1.05)");
        })
        .on("mousemove", function (event) {
          tooltip.style("left", (event.pageX + 15) + "px")
            .style("top", (event.pageY - 15) + "px");
        })
        .on("mouseout", function () {
          tooltip.style("display", "none");
          d3.select(this)
            .transition()
            .duration(200)
            .attr("transform", "scale(1)");
        });

      // Ajouter la l√©gende
      const legend = chartDiv.append("div")
        .attr("class", "legend");

      const legendItems = legend.selectAll(".legend-item")
        .data(regionData.data)
        .enter()
        .append("div")
        .attr("class", "legend-item");

      legendItems.append("div")
        .attr("class", "legend-color")
        .style("background-color", d => d.color);

      legendItems.append("span")
        .attr("class", "legend-text")
        .text(d => `${d.category}: ${d.value}`);

      // Ajouter les statistiques
      const total = d3.sum(regionData.data, d => d.value);
      const statsGrid = chartDiv.append("div")
        .attr("class", "stats-grid");

      statsGrid.append("div")
        .attr("class", "stat-card")
        .html(`
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">Total</div>
                `);

      statsGrid.append("div")
        .attr("class", "stat-card")
        .html(`
                    <div class="stat-value">${regionData.data.length}</div>
                    <div class="stat-label">Cat√©gories</div>
                `);

      const maxCategory = d3.max(regionData.data, d => d.value);
      statsGrid.append("div")
        .attr("class", "stat-card")
        .html(`
                    <div class="stat-value">${maxCategory}</div>
                    <div class="stat-label">Max</div>
                `);

      const avg = Math.round(total / regionData.data.length);
      statsGrid.append("div")
        .attr("class", "stat-card")
        .html(`
                    <div class="stat-value">${avg}</div>
                    <div class="stat-label">Moyenne</div>
                `);
    }

    // Fonction pour afficher le message "pas de donn√©es"
    function showNoDataMessage(regionName) {
      doughnutContainer.selectAll("*").remove();

      doughnutContainer.append("div")
        .attr("class", "no-data")
        .html(`
                    <h3>‚ùå Donn√©es non disponibles</h3>
                    <p>La r√©gion "${regionName}" ne dispose pas de donn√©es pour le moment.</p>
                    <p>Veuillez s√©lectionner une autre r√©gion.</p>
                `);
    }
  </script>
</body>

</html>